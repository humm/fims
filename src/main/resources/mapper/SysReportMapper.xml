<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hoomoomoo.fims.app.dao.SysReportDao">

    <select id="selectIncomeYear" parameterType="com.hoomoomoo.fims.app.model.SysReportQueryModel"
            resultType="com.hoomoomoo.fims.app.model.SysReportModel">
        select
            '全年度' title,
            '单位：万元' subTitle,
            <if test="userId != null">
                s.user_name reportName,
            </if>
            trunc(sum(t.income_amount)/10000, 2) reportNum,
            to_number(substr(to_char(t.income_date, 'yyyyMMdd'), 1, 4)) reportDate
        from sys_income t, sys_user s
        where t.user_id = s.user_id
            <if test="userId != null">
                and t.user_id = #{userId}
            </if>
        group by
            <if test="userId != null">
                s.user_name,
            </if>
            to_number(substr(to_char(t.income_date, 'yyyyMMdd'), 1, 4))
        order by
            <if test="userId != null">
                s.user_name,
            </if>
            to_number(substr(to_char(t.income_date, 'yyyyMMdd'), 1, 4))
    </select>

    <select id="selectIncomeMonth" parameterType="com.hoomoomoo.fims.app.model.SysReportQueryModel"
            resultType="com.hoomoomoo.fims.app.model.SysReportModel">
        select
            #{reportValue} || '年' title,
            '单位：元' subTitle,
            <if test="userId != null">
                s.user_name reportName,
            </if>
            sum(t.income_amount) reportNum,
            to_number(substr(to_char(t.income_date, 'yyyyMMdd'), 5, 2)) reportDate
        from sys_income t, sys_user s
        where t.user_id = s.user_id
        and substr(to_char(t.income_date, 'yyyyMMdd'), 1, 4) = #{reportValue}
            <if test="userId != null">
                and t.user_id = #{userId}
            </if>
        group by
            <if test="userId != null">
                s.user_name,
            </if>
            to_number(substr(to_char(t.income_date, 'yyyyMMdd'), 5, 2))
        order by
            <if test="userId != null">
                s.user_name,
            </if>
            to_number(substr(to_char(t.income_date, 'yyyyMMdd'), 5, 2))
    </select>

    <select id="selectIncomeSource" parameterType="com.hoomoomoo.fims.app.model.SysReportQueryModel"
            resultType="com.hoomoomoo.fims.app.model.SysReportModel">
        select
            '收入来源' title,
            '单位：万元' subtitle,
            s.dictionary_caption reportName,
            trunc(sum(t.income_amount) / 10000, 2) reportnum
        from sys_income t, sys_dictionary s
        where t.income_company = s.dictionary_code || '-' ||  s.dictionary_item
        <if test="userId != null">
            and t.user_id = #{userId}
        </if>
        group by s.dictionary_caption
        order by s.dictionary_caption
    </select>

    <select id="selectIncomeType" parameterType="com.hoomoomoo.fims.app.model.SysReportQueryModel"
            resultType="com.hoomoomoo.fims.app.model.SysReportModel">
        select
            '收入类型' title,
            '单位：万元' subtitle,
            s.dictionary_caption reportName,
            trunc(sum(t.income_amount) / 10000, 2) reportnum
        from sys_income t, sys_dictionary s
        where t.income_type = s.dictionary_code || '-' ||  s.dictionary_item
        <if test="userId != null">
            and t.user_id = #{userId}
        </if>
        group by s.dictionary_caption
        order by s.dictionary_caption
    </select>

    <select id="selectIncomePeak" parameterType="com.hoomoomoo.fims.app.model.SysReportQueryModel"
            resultType="com.hoomoomoo.fims.app.model.SysReportModel">
        select
            '收入极值' title,
            '单位：元' subtitle,
            reportname,
            reportnum
        from (select
                    s.dictionary_caption reportname,
                    max(t.income_amount) reportnum
              from sys_income t, sys_dictionary s
              where t.income_type = s.dictionary_code || '-' || s.dictionary_item
              <if test="userId != null">
                 and t.user_id = #{userId}
              </if>
              group by s.dictionary_caption
              order by max(t.income_amount) desc
        ) m
        where rownum = 1
        union all
        select
            '收入极值' title,
            '单位：元' subtitle,
            reportname,
            reportnum
        from (select s.dictionary_caption reportname,
                     min(t.income_amount) reportnum
              from sys_income t, sys_dictionary s
              where t.income_type = s.dictionary_code || '-' || s.dictionary_item
              <if test="userId != null">
                 and t.user_id = #{userId}
              </if>
              group by s.dictionary_caption
              order by min(t.income_amount)
        ) s
        where rownum = 1
    </select>

</mapper>